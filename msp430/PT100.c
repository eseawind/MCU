/**********************************************
 *
 * 		Author	:		Shawn Guo
 *      Mail    :       iguoxiaopeng@gmail.com
 * 		Date	:       2013/8/9
 *      Last    :
 * 		Notes	:       PT100温度传感器
 * 		Tool    :       MSP430FX2XX PT100
 *
 *
 *      pt100   ---> 惠更斯电桥  --->    差分放大器   --->    AD采样
 *      ---->   计算温度值   --->    LCD显示
 **********************************************/

/*****************************************************************************
* @file       PT100.c
* @addtogroup PT100
* @{
******************************************************************************/
#include <msp430f2618.h>
#include "clock.h"
#include "PT100.h"


/***************************************************************************//**
 * @brief   根据ADC的采样值计算温度.
 * @param   vadc, ADC采样后换算的电压值, 单位: mv
 * @return  温度的100倍，温度超过瓶颈则为0xffff.
 *******************************************************************************/
unsigned int PT100_Temp(unsigned int vadc)
{
    unsigned long pt100 = (((unsigned long)((PT100_U3 + ((vadc) / (PT100_VADC_TIME)))) * PT100_R2 * 100) / (PT100_VDD - (PT100_U3 + ((vadc) / (PT100_VADC_TIME)))));

    //二分法查找温度值
    unsigned int start = 0, mid = 0, endd = 1023;
    unsigned int dat = 0;

    // 1. 检查数据合法性
    if ((pt100 > PT100_MAX_TEMP ) || (pt100 < PT100_MIN_TEMP))
    {
        return 0xffff;  //错误标志
    }

    // 2. 开始二分法查找
    while (start <= endd)
    {
        mid = (endd + start) >> 1;
        dat = PT100_ROM[mid];
        if (pt100 > dat)
        {
            start = mid + 1;
        }
        else if(pt100 < dat)
        {
            if(mid)
            {
                endd = mid - 1;
            }
            else    //mid = 0的特殊情况
            {
                break;
            }
        }
        else
        {
            break;  //找到为中间值mid了
        }
    }//运行完后得到值mid。


    //根据下标计算温度值

    if (dat == pt100) // 正好相等
    {
        return mid * 10;
    }
    else
    {
        if (dat > pt100)
        {
            return (10*(mid - 1)  + 10*(pt100 - PT100_ROM[mid - 1]) / (PT100_ROM[mid] - PT100_ROM[mid - 1]));
        }
        else
        {
            return (10 * mid + 10*(pt100 - PT100_ROM[mid]) / (PT100_ROM[mid + 1]-PT100_ROM[mid]));
        }
    }

}

const unsigned int PT100_ROM[PT100_ROM_NUM]=
{
    10000 , 10003 , 10007 , 10011 , 10015 , 10019 , 10023 , 10027 , 10031 , 10035 ,
    10039 , 10042 , 10046 , 10050 , 10054 , 10058 , 10062 , 10066 , 10070 , 10074 ,
    10078 , 10082 , 10085 , 10089 , 10093 , 10097 , 10101 , 10105 , 10109 , 10113 ,
    10117 , 10121 , 10125 , 10128 , 10132 , 10136 , 10140 , 10144 , 10148 , 10152 ,
    10156 , 10160 , 10164 , 10167 , 10171 , 10175 , 10179 , 10183 , 10187 , 10191 ,
    10195 , 10199 , 10203 , 10206 , 10210 , 10214 , 10218 , 10222 , 10226 , 10230 ,
    10234 , 10238 , 10242 , 10245 , 10249 , 10253 , 10257 , 10261 , 10265 , 10269 ,
    10273 , 10277 , 10281 , 10285 , 10288 , 10292 , 10296 , 10300 , 10304 , 10308 ,
    10312 , 10316 , 10320 , 10323 , 10327 , 10331 , 10335 , 10339 , 10343 , 10347 ,
    10351 , 10355 , 10359 , 10362 , 10366 , 10370 , 10374 , 10378 , 10382 , 10386 ,
    10390 , 10394 , 10398 , 10401 , 10405 , 10409 , 10413 , 10417 , 10421 , 10425 ,
    10429 , 10433 , 10437 , 10440 , 10444 , 10448 , 10452 , 10456 , 10460 , 10464 ,
    10468 , 10472 , 10475 , 10479 , 10483 , 10487 , 10491 , 10495 , 10499 , 10503 ,
    10507 , 10511 , 10514 , 10518 , 10522 , 10526 , 10530 , 10534 , 10538 , 10542 ,
    10546 , 10549 , 10553 , 10557 , 10561 , 10565 , 10569 , 10573 , 10577 , 10581 ,
    10584 , 10588 , 10592 , 10596 , 10600 , 10604 , 10608 , 10612 , 10616 , 10619 ,
    10623 , 10627 , 10631 , 10635 , 10639 , 10643 , 10647 , 10651 , 10654 , 10658 ,
    10662 , 10666 , 10670 , 10674 , 10678 , 10682 , 10686 , 10689 , 10693 , 10697 ,
    10701 , 10705 , 10709 , 10713 , 10717 , 10721 , 10724 , 10728 , 10732 , 10736 ,
    10740 , 10744 , 10748 , 10752 , 10756 , 10759 , 10763 , 10767 , 10771 , 10775 ,
    10779 , 10783 , 10787 , 10791 , 10794 , 10798 , 10802 , 10806 , 10810 , 10814 ,
    10188 , 10822 , 11455 , 12089 , 12723 , 13357 , 13991 , 14625 , 15259 , 15893 ,
    10857 , 10860 , 10864 , 10868 , 10872 , 10876 , 10880 , 10884 , 10888 , 10891 ,
    10895 , 10899 , 10903 , 10907 , 10911 , 10915 , 10919 , 10923 , 10926 , 10930 ,
    10934 , 10938 , 10942 , 10946 , 10950 , 10954 , 10957 , 10961 , 10965 , 10969 ,
    10973 , 10977 , 10981 , 10985 , 10988 , 10992 , 10996 , 11000 , 11004 , 11008 ,
    11012 , 11016 , 11020 , 11023 , 11027 , 11031 , 11035 , 11039 , 11043 , 11047 ,
    11051 , 11054 , 11058 , 11062 , 11066 , 11070 , 11074 , 11078 , 11082 , 11085 ,
    11089 , 11093 , 11097 , 11101 , 11105 , 11109 , 11113 , 11116 , 11120 , 11124 ,
    11128 , 11132 , 11136 , 11140 , 11144 , 11147 , 11151 , 11155 , 11159 , 11163 ,
    11167 , 11171 , 11175 , 11178 , 11182 , 11186 , 11190 , 11194 , 11198 , 11202 ,
    11206 , 11209 , 11213 , 11217 , 11221 , 11225 , 11229 , 11233 , 11237 , 11240 ,
    11244 , 11248 , 11252 , 11256 , 11260 , 11264 , 11267 , 11271 , 11275 , 11279 ,
    11399 , 11403 , 11407 , 11411 , 11414 , 11418 , 11422 , 11426 , 11430 , 11434 ,
    11322 , 11326 , 11329 , 11333 , 11337 , 11341 , 11345 , 11349 , 11353 , 11356 ,
    11360 , 11364 , 11368 , 11372 , 11376 , 11380 , 11384 , 11387 , 11391 , 11395 ,
    11399 , 11403 , 11407 , 11411 , 11414 , 11418 , 11422 , 11426 , 11430 , 11434 ,
    11438 , 11442 , 11445 , 11449 , 11453 , 11457 , 11461 , 11465 , 11469 , 11472 ,
    11476 , 11480 , 11484 , 11488 , 11492 , 11496 , 11500 , 11503 , 11507 , 11511 ,
    11515 , 11519 , 11523 , 11527 , 11530 , 11534 , 11538 , 11542 , 11546 , 11550 ,
    11554 , 11557 , 11561 , 11565 , 11569 , 11573 , 11577 , 11581 , 11584 , 11588 ,
    11592 , 11596 , 11600 , 11604 , 11608 , 11612 , 11615 , 11619 , 11623 , 11627 ,
    11631 , 11635 , 11639 , 11642 , 11646 , 11650 , 11654 , 11658 , 11662 , 11666 ,
    11669 , 11673 , 11677 , 11681 , 11685 , 11689 , 11693 , 11696 , 11700 , 11704 ,
    11708 , 11712 , 11716 , 11720 , 11723 , 11727 , 11731 , 11735 , 11739 , 11743 ,
    11747 , 11750 , 11754 , 11758 , 11762 , 11766 , 11770 , 11774 , 11777 , 11781 ,
    11785 , 11789 , 11793 , 11797 , 11801 , 11804 , 11808 , 11812 , 11816 , 11820 ,
    11824 , 11828 , 11831 , 11835 , 11839 , 11843 , 11847 , 11851 , 11855 , 11858 ,
    11862 , 11866 , 11870 , 11874 , 11878 , 11881 , 11885 , 11889 , 11893 , 11897 ,
    11901 , 11905 , 11908 , 11912 , 11916 , 11920 , 11924 , 11928 , 11932 , 11935 ,
    11939 , 11943 , 11947 , 11951 , 11955 , 11958 , 11962 , 11966 , 11970 , 11974 ,
    11978 , 11982 , 11985 , 11989 , 11993 , 11997 , 12001 , 12005 , 12009 , 12012 ,
    12016 , 12020 , 12024 , 12028 , 12032 , 12035 , 12039 , 12043 , 12047 , 12051 ,
    12055 , 12059 , 12062 , 12066 , 12070 , 12074 , 12078 , 12082 , 12085 , 12089 ,
    12093 , 12097 , 12101 , 12105 , 12109 , 12112 , 12116 , 12120 , 12124 , 12128 ,
    12132 , 12135 , 12139 , 12143 , 12147 , 12151 , 12155 , 12159 , 12162 , 12166 ,
    12170 , 12174 , 12178 , 12182 , 12185 , 12189 , 12193 , 12197 , 12201 , 12205 ,
    12208 , 12212 , 12216 , 12220 , 12224 , 12228 , 12232 , 12235 , 12239 , 12243 ,
    12247 , 12251 , 12255 , 12258 , 12262 , 12266 , 12270 , 12274 , 12278 , 12281 ,
    12285 , 12289 , 12293 , 12297 , 12301 , 12304 , 12308 , 12312 , 12316 , 12320 ,
    12324 , 12328 , 12331 , 12335 , 12339 , 12343 , 12347 , 12351 , 12354 , 12358 ,
    12362 , 12366 , 12370 , 12374 , 12377 , 12381 , 12385 , 12389 , 12393 , 12397 ,
    12400 , 12404 , 12408 , 12412 , 12416 , 12420 , 12423 , 12427 , 12431 , 12435 ,
    12439 , 12443 , 12446 , 12450 , 12454 , 12458 , 12462 , 12466 , 12469 , 12473 ,
    12477 , 12481 , 12485 , 12489 , 12492 , 12496 , 12500 , 12504 , 12508 , 12512 ,
    12516 , 12519 , 12523 , 12527 , 12531 , 12535 , 12538 , 12542 , 12546 , 12550 ,
    12554 , 12558 , 12561 , 12565 , 12569 , 12573 , 12577 , 12581 , 12584 , 12588 ,
    12592 , 12596 , 12600 , 12604 , 12607 , 12611 , 12615 , 12619 , 12623 , 12627 ,
    12630 , 12634 , 12638 , 12642 , 12646 , 12650 , 12653 , 12657 , 12661 , 12665 ,
    12669 , 12673 , 12676 , 12680 , 12684 , 12688 , 12692 , 12696 , 12699 , 12703 ,
    12707 , 12711 , 12715 , 12718 , 12722 , 12726 , 12730 , 12734 , 12738 , 12741 ,
    12745 , 12746 , 12748 , 12749 , 12750 , 12751 , 12752 , 12753 , 12754 , 12755 ,
    12784 , 12787 , 12791 , 12795 , 12799 , 12803 , 12806 , 12810 , 12814 , 12818 ,
    12822 , 12826 , 12829 , 12833 , 12837 , 12841 , 12845 , 12849 , 12852 , 12856 ,
    12860 , 12864 , 12868 , 12871 , 12875 , 12879 , 12883 , 12887 , 12891 , 12894 ,
    12898 , 12902 , 12906 , 12910 , 12914 , 12917 , 12921 , 12925 , 12929 , 12933 ,
    12936 , 12940 , 12944 , 12948 , 12952 , 12956 , 12959 , 12963 , 12967 , 12971 ,
    12975 , 12978 , 12982 , 12986 , 12990 , 12994 , 12998 , 13001 , 13005 , 13009 ,
    13013 , 13017 , 13020 , 13024 , 13028 , 13032 , 13036 , 13040 , 13043 , 13047 ,
    13051 , 13055 , 13059 , 13062 , 13066 , 13070 , 13074 , 13078 , 13082 , 13085 ,
    13089 , 13093 , 13097 , 13101 , 13104 , 13108 , 13112 , 13116 , 13120 , 13124 ,
    13127 , 13131 , 13135 , 13139 , 13143 , 13146 , 13150 , 13154 , 13158 , 13162 ,
    13165 , 13169 , 13173 , 13177 , 13181 , 13185 , 13188 , 13192 , 13196 , 13200 ,
    13204 , 13207 , 13211 , 13215 , 13219 , 13223 , 13226 , 13230 , 13234 , 13238 ,
    13242 , 13246 , 13249 , 13253 , 13257 , 13261 , 13265 , 13268 , 13272 , 13276 ,
    13280 , 13284 , 13287 , 13291 , 13295 , 13299 , 13303 , 13307 , 13310 , 13314 ,
    13318 , 13322 , 13326 , 13329 , 13333 , 13337 , 13341 , 13345 , 13348 , 13352 ,
    13356 , 13360 , 13364 , 13367 , 13371 , 13375 , 13379 , 13383 , 13386 , 13390 ,
    13394 , 13358 , 13322 , 13286 , 13249 , 13213 , 13177 , 13141 , 13105 , 13068 ,
    13432 , 13436 , 13440 , 13444 , 13447 , 13451 , 13455 , 13459 , 13463 , 13466 ,
    13470 , 13474 , 13478 , 13482 , 13485 , 13489 , 13493 , 13497 , 13501 , 13504 ,
    13508 , 13512 , 13516 , 13520 , 13523 , 13527 , 13531 , 13535 , 13539 , 13542 ,
    13546 , 13550 , 13554 , 13558 , 13561 , 13565 , 13569 , 13573 , 13577 , 13580 ,
    13584 , 13588 , 13592 , 13596 , 13599 , 13603 , 13607 , 13611 , 13615 , 13618 ,
    13622 , 13626 , 13630 , 13634 , 13637 , 13641 , 13645 , 13649 , 13653 , 13656 ,
    13660 , 13664 , 13668 , 13672 , 13675 , 13679 , 13683 , 13687 , 13691 , 13694 ,
    13698 , 13702 , 13706 , 13710 , 13713 , 13717 , 13721 , 13725 , 13729 , 13732 ,
    13736 , 13740 , 13744 , 13748 , 13751 , 13755 , 13759 , 13763 , 13767 , 13770 ,
    13774 , 13778 , 13782 , 13786 , 13789 , 13793 , 13797 , 13801 , 13805 , 13808 ,
    13812 , 13816 , 13820 , 13824 , 13827 , 13831 , 13835 , 13839 , 13842 , 13846 ,
    13850 , 13854 , 13858 , 13861 , 13865 , 13869 , 13873 , 13877 , 13880 , 13884 ,
    65530 , 65530 , 65530 , 65530 , 65530 , 65530 , 65530 , 65530 , 65530 , 65530 ,
    65530 , 65530 , 65530 , 65530
};




/***************************************************************************//**
 * @}
 ******************************************************************************/
