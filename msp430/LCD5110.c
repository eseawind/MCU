/**********************************************
 *
 * 		Author	:		Shawn Guo
 * 		Date	:		2013/8/14
 *      Last    :       2013/8/14
 * 		Notes	:		LCD5110驱动
 * 		Tool    :	    MSP430
 *
 **********************************************/
#include <msp430f2618.h>
#include "LCD5110.h"
#include "clock.h"
#include "USCI.h"


/**********************************************
 *  除了配置硬件SPI, 不要改动其他程序. 其他程序与硬件无关.
 *  模拟SPI直接修改头文件即可.确保对应的IO端口正常工作.
 **********************************************/

// 字符LCD模，从ASCII码的32开始
extern const unsigned char font6x8[][6];
static unsigned char LCD5110_BUFFER[] = "+00000000";



void LCD5110_IO() // I/O口配置
{
    LCD5110_CE_DIR;
    LCD5110_CE_0;
    LCD5110_RST_DIR;
    LCD5110_DC_DIR;
    LCD5110_DC_0;
#ifdef LCD5110_MONI_SPI
    LCD5110_SDIN_DIR;
    LCD5110_SDIN_0;
    LCD5110_SCLK_DIR;
    LCD5110_SCLK_0;
#else
    //配置硬件SPI, UCB1,第二个时钟沿改变, SCLK空闲低电平, 高位先发, 8-bits, 3-SPI主机模式
    //由于5110是在SCLK的上升沿采样SDIN,因此不能再上升沿改变数据.
    USCI_SPI_Init(3, 2, 5, 1, LCD5110_SCLK_FF); //默认分频,达到SPI 1M的效果
#endif
}



void LCD5110_Init()
{
    LCD5110_IO();
// 接电源后，内部寄存器和RAM的内容不确定。必须应用一个RES
//脉冲。注意，不正确的复位是危险的，可能会损坏设备。

    // 产生一个让LCD5110复位的低电平脉冲，复位所有寄存器。注意RAM没有被影响
    LCD5110_RST_0; //复位等待（内部自带上电复位电路），时间较长
    DELAY_US(10);
    LCD5110_RST_1;

    // 关闭LCD5110
    LCD5110_CE_1;
    DELAY_US(1);
    // 再使能LCD5110
    LCD5110_CE_0;
    DELAY_US(1);

    // 掉电控制；进入模式；扩展指令设置 0010 0 PD   V   H
    // PD = 0,芯片是活动的；PD = 1,掉电模式
    //  V = 0,水平寻址； V = 1，垂直寻址
    // H = 0，使用基本指令集； H = 1， 使用扩展指令集(设置温度系数，设置偏置系统，设置VOP寄存器)
    LCD5110_Write_Byte(0x21, 0);	// 使用扩展命令设置LCD5110模式，V =0，水平寻址


    LCD5110_Write_Byte(0xc8, 0);	// 设置偏置电压 ？？？？？？？？？？？？？

    // 0000 01 TC1 TC0 设置温度系数TCx
    // 00，温度系数0     01，温度系数1        10，温度系数2        11 温度系数3
    LCD5110_Write_Byte(0x06, 0);	// 温度校正

    //设置偏置系统    0001 0  BS2     BS1     BS0
    LCD5110_Write_Byte(0x13, 0);	//混合比 1:48


    LCD5110_Write_Byte(0x20, 0);	// 使用基本命令

    LCD5110_Clear();	        // 清屏

    //设置显示配置，0000 1 D    0      E
    // DE:  00 显示空白     01，普通模式         10 = 开所有显示段
    // 11，翻转映像模式
    LCD5110_Write_Byte(0x0c, 0);	// 设定显示模式，D = 1，开所有显示段，正常显示

    // 结束使能LCD5110
    LCD5110_CE_1;
}

void LCD5110_Clear(void)
{
    unsigned int i = 0;

    LCD5110_Write_Byte(0x0c, 0);//普通模式显示
    LCD5110_Write_Byte(0x80, 0);//设置ram x地址

    for (i=0; i<504; i++)
        LCD5110_Write_Byte(0, 1);	//对ram写0,从0到503
}

//设置LCD5110坐标函数
// X: 0-83      Y: 0-5
// 注意水平寻址与垂直寻址的区别
void LCD5110_Set_XY(unsigned char X, unsigned char Y)
{
    // 设置RAM的Y值：    0100 0  Y2  Y1  Y0
    LCD5110_Write_Byte(0x40 | Y, 0);		// column

    //设置RAM的X值：     1 X6 X5 X4 X3 X2 X1 X0
    LCD5110_Write_Byte(0x80 | X, 0);          	// row
}

void LCD5110_Write_Char(unsigned char c)  // 在LCD5110上写入一个字符
{
    unsigned char line = 0;

    c -= 32;   // ASCII码转化，对应到font6x8数组对应的字模

    for (line=0; line<6; line++)
        LCD5110_Write_Byte(font6x8[c][line], 1);
}

//显示字符串s.若S = 0, 则显示默认LCD5110_BUFFER.
void LCD5110_Write_String(unsigned char X,unsigned char Y,char *s)
{
    LCD5110_Set_XY(X,Y);   //只需设置起始位即可

    if(s == 0)
    {
        s = (char*)LCD5110_BUFFER;
    }

    while (*s)
    {
        LCD5110_Write_Char(*s);
        s++;
    }
}

// 给LCD5110写入数据/命令。 当command = 0，即写入命令，命令内容为dat
//             当command = 1,即写入数据，数据内容为dat
void LCD5110_Write_Byte(unsigned char dat, unsigned char command)
{
#ifdef LCD5110_MONI_SPI
    unsigned char i = 0;
#endif

    LCD5110_CE_0; //使能LCD5110，准备写入数据
    DELAY_US(1);

    if (command == 0)   // 判断发送数据/命令，注意D/C指出一个字节是命令还是数据，DC将在第8个字节发送完以后被检测
        LCD5110_DC_0;
    else
        LCD5110_DC_1;

#ifdef LCD5110_MONI_SPI

    for(i = 0; i < 8; i++) // 发送8个字节的dat数据
    {
        if(dat & 0x80)
            LCD5110_SDIN_1;
        else
            LCD5110_SDIN_0;

        LCD5110_SCLK_0;               // 准备一个SCLK上升沿，发送SDIN输入置LCD5110

        dat = dat << 1;

        LCD5110_SCLK_1;
    }
#else
    while(!(UC1IFG & UCB1TXIFG));
    UCB1TXBUF = dat;
    while(!(UC1IFG & UCB1RXIFG));
    UC1IFG &= ~UCB1RXIFG;
#endif // LCD5110_MONI_SPI
    LCD5110_CE_1;   //关闭使能LCD5110
}

//将16位的long值转换为字符存储在LCD5110_BUFFER[]中.不考虑溢出,有符号位表示.
void LCD5110_Long2Char(long templong)
{
    int i = 0;

    if(templong >= 0)   //正数
    {
        LCD5110_BUFFER[0] = '+';
    }
    else
    {
        LCD5110_BUFFER[0] = '-';
        templong = ~templong;
        templong++;
    }
    for(i = 8; i >= 1; i--)
    {
        LCD5110_BUFFER[i] = (templong % 10) + '0';   //ASCII码转换
        templong /= 10;
    }
}



// 字符LCD5110模，从ASCII码的32开始
const unsigned char font6x8[][6] =
{
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   // sp
    { 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 },   // !
    { 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 },   // "
    { 0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14 },   // #
    { 0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12 },   // $
    { 0x00, 0x62, 0x64, 0x08, 0x13, 0x23 },   // %
    { 0x00, 0x36, 0x49, 0x55, 0x22, 0x50 },   // &
    { 0x00, 0x00, 0x05, 0x03, 0x00, 0x00 },   // '
    { 0x00, 0x00, 0x1c, 0x22, 0x41, 0x00 },   // (
    { 0x00, 0x00, 0x41, 0x22, 0x1c, 0x00 },   // )
    { 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14 },   // *
    { 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08 },   // +
    { 0x00, 0x00, 0x00, 0xA0, 0x60, 0x00 },   // ,
    { 0x00, 0x08, 0x08, 0x08, 0x08, 0x08 },   // -
    { 0x00, 0x00, 0x60, 0x60, 0x00, 0x00 },   // .
    { 0x00, 0x20, 0x10, 0x08, 0x04, 0x02 },   // /
    { 0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E },   // 0
    { 0x00, 0x00, 0x42, 0x7F, 0x40, 0x00 },   // 1
    { 0x00, 0x42, 0x61, 0x51, 0x49, 0x46 },   // 2
    { 0x00, 0x21, 0x41, 0x45, 0x4B, 0x31 },   // 3
    { 0x00, 0x18, 0x14, 0x12, 0x7F, 0x10 },   // 4
    { 0x00, 0x27, 0x45, 0x45, 0x45, 0x39 },   // 5
    { 0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30 },   // 6
    { 0x00, 0x01, 0x71, 0x09, 0x05, 0x03 },   // 7
    { 0x00, 0x36, 0x49, 0x49, 0x49, 0x36 },   // 8
    { 0x00, 0x06, 0x49, 0x49, 0x29, 0x1E },  // 9
    { 0x00, 0x00, 0x36, 0x36, 0x00, 0x00 },   // :
    { 0x00, 0x00, 0x56, 0x36, 0x00, 0x00 },   // ;
    { 0x00, 0x08, 0x14, 0x22, 0x41, 0x00 },   // <
    { 0x00, 0x14, 0x14, 0x14, 0x14, 0x14 },   // =
    { 0x00, 0x00, 0x41, 0x22, 0x14, 0x08 },   // >
    { 0x00, 0x02, 0x01, 0x51, 0x09, 0x06 },   // ?
    { 0x00, 0x32, 0x49, 0x59, 0x51, 0x3E },   // @
    { 0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C },   // A
    { 0x00, 0x7F, 0x49, 0x49, 0x49, 0x36 },   // B
    { 0x00, 0x3E, 0x41, 0x41, 0x41, 0x22 },   // C
    { 0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C },   // D
    { 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41 },   // E
    { 0x00, 0x7F, 0x09, 0x09, 0x09, 0x01 },   // F
    { 0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A },   // G
    { 0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F },   // H
    { 0x00, 0x00, 0x41, 0x7F, 0x41, 0x00 },   // I
    { 0x00, 0x20, 0x40, 0x41, 0x3F, 0x01 },   // J
    { 0x00, 0x7F, 0x08, 0x14, 0x22, 0x41 },   // K
    { 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40 },   // L
    { 0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F },   // M
    { 0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F },   // N
    { 0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E },   // O
    { 0x00, 0x7F, 0x09, 0x09, 0x09, 0x06 },   // P
    { 0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E },   // Q
    { 0x00, 0x7F, 0x09, 0x19, 0x29, 0x46 },   // R
    { 0x00, 0x46, 0x49, 0x49, 0x49, 0x31 },   // S
    { 0x00, 0x01, 0x01, 0x7F, 0x01, 0x01 },   // T
    { 0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F },   // U
    { 0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F },   // V
    { 0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F },   // W
    { 0x00, 0x63, 0x14, 0x08, 0x14, 0x63 },   // X
    { 0x00, 0x07, 0x08, 0x70, 0x08, 0x07 },   // Y
    { 0x00, 0x61, 0x51, 0x49, 0x45, 0x43 },   // Z
    { 0x00, 0x00, 0x7F, 0x41, 0x41, 0x00 },   // [
    { 0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55 },   // 55
    { 0x00, 0x00, 0x41, 0x41, 0x7F, 0x00 },   // ]
    { 0x00, 0x04, 0x02, 0x01, 0x02, 0x04 },   // ^
    { 0x00, 0x40, 0x40, 0x40, 0x40, 0x40 },   // _
    { 0x00, 0x00, 0x01, 0x02, 0x04, 0x00 },   // '
    { 0x00, 0x20, 0x54, 0x54, 0x54, 0x78 },   // a
    { 0x00, 0x7F, 0x48, 0x44, 0x44, 0x38 },   // b
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x20 },   // c
    { 0x00, 0x38, 0x44, 0x44, 0x48, 0x7F },   // d
    { 0x00, 0x38, 0x54, 0x54, 0x54, 0x18 },   // e
    { 0x00, 0x08, 0x7E, 0x09, 0x01, 0x02 },   // f
    { 0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C },   // g
    { 0x00, 0x7F, 0x08, 0x04, 0x04, 0x78 },   // h
    { 0x00, 0x00, 0x44, 0x7D, 0x40, 0x00 },   // i
    { 0x00, 0x40, 0x80, 0x84, 0x7D, 0x00 },   // j
    { 0x00, 0x7F, 0x10, 0x28, 0x44, 0x00 },   // k
    { 0x00, 0x00, 0x41, 0x7F, 0x40, 0x00 },   // l
    { 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78 },   // m
    { 0x00, 0x7C, 0x08, 0x04, 0x04, 0x78 },   // n
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x38 },   // o
    { 0x00, 0xFC, 0x24, 0x24, 0x24, 0x18 },   // p
    { 0x00, 0x18, 0x24, 0x24, 0x18, 0xFC },   // q
    { 0x00, 0x7C, 0x08, 0x04, 0x04, 0x08 },   // r
    { 0x00, 0x48, 0x54, 0x54, 0x54, 0x20 },   // s
    { 0x00, 0x04, 0x3F, 0x44, 0x40, 0x20 },   // t
    { 0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C },   // u
    { 0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C },   // v
    { 0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C },   // w
    { 0x00, 0x44, 0x28, 0x10, 0x28, 0x44 },   // x
    { 0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C },   // y
    { 0x00, 0x44, 0x64, 0x54, 0x4C, 0x44 },   // z
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x14 }    // horiz lines
};

